name: Deploy to Dev Environment

on:
  push:
    branches:
      - dev
  workflow_dispatch:    

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout deployment repository
      uses: actions/checkout@v3

    - name: Checkout server repository
      uses: actions/checkout@v3
      with:
        repository: Monkey-Business-z-o-o/eduplanner-server
        ref: dev
        token: ${{ secrets.DDToken }}
        path: eduplanner-server

    - name: Checkout app repository
      uses: actions/checkout@v3
      with:
        repository: Monkey-Business-z-o-o/eduplanner-app
        ref: dev
        token: ${{ secrets.DDToken }}
        path: eduplanner-app

    - name: Install cloudflared
      run: |
        curl -LO https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared
        sudo chmod +x /usr/local/bin/cloudflared

    - name: Install sshpass
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass

    - name: Configure SSH for Cloudflare Tunnel
      run: |
        mkdir -p ~/.ssh
        echo "Host ssh.kebson.fun
          ProxyCommand cloudflared access ssh --hostname %h
          User edutest
          Port 222
        " >> ~/.ssh/config
        chmod 600 ~/.ssh/config

    - name: Test SSH connection
      env:
        SSHPASS: ${{ secrets.EDUTEST }}
      run: |
        sshpass -e ssh -o StrictHostKeyChecking=no edutest@ssh.kebson.fun "echo Connection successful"

    - name: Ensure destination directory exists
      env:
        SSHPASS: ${{ secrets.EDUTEST }}
      run: |
        sshpass -e ssh -o StrictHostKeyChecking=no edutest@ssh.kebson.fun "mkdir -p /srv/EduTest"

    - name: Cleanup previous deployment
      env:
        SSHPASS: ${{ secrets.EDUTEST }}
      run: |
        sshpass -e ssh -o StrictHostKeyChecking=no edutest@ssh.kebson.fun "rm -rf /srv/EduTest/*"

    - name: Transfer repositories to server
      env:
        SSHPASS: ${{ secrets.EDUTEST }}
      run: |
        sshpass -e scp -r ./eduplaner-deploy edutest@ssh.kebson.fun:/srv/ &&
        sshpass -e scp -r ./eduplanner-server edutest@ssh.kebson.fun:/srv/ &&
        sshpass -e scp -r ./eduplanner-app edutest@ssh.kebson.fun:/srv/

    - name: Deploy application
      env:
        SSHPASS: ${{ secrets.EDUTEST }}
      run: |
        sshpass -e ssh -o StrictHostKeyChecking=no edutest@ssh.kebson.fun "
        cd /srv/EduTest &&
        docker-compose down &&
        docker-compose up -d
        "
